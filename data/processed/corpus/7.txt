doc_id: 7
Лекция 2 БД и ORM Разработка интернет приложений Канев Антон Игоревич
Повторение БД • Курс по Postgre в Jupyter ноутбуках https://aiintro.wiki.iu5edu.ru/docs/db/ • Курс PostgreSQL с 4 семестра • https://github.com/iu5git/Database
Виды баз данных • Документо-ориентированные • Реляционные • in memory • Графовые • Ключ-значение
Виды баз данных
Реляционные базы данных • Relation – отношение, связь • Нормализация данных для устранения аномалий и избыточности
ER диаграмма • Отношения таблицы • Атрибуты и типы данных • Первичные и внешние ключи
ER в StarUML
Типы данных • Дата • Целочисленный • Вещественный • Строковый
Типы данных • CLOB • BLOB • XML
SQL SELECT DeptID, SUM(SaleAmount) • DDL – Data Definition Language FROM Sales CREATE, ALTER, DROP WHERE SaleDate = '01-Jan-2000’ GROUP BY DeptID • DML – Data Manipulation Language HAVING SUM(SaleAmount) > 1000 SELECT, INSERT, UPDATE, DELETE • DCL – Data Control Language Примеры транзакций в курсе: GRANT, REVOKE • Нужно поменять местами две позиции в заявке • TCL – Transaction Control Language • В услуге хранится количество товара на COMMIT, ROLLBACK, SAVEPOINT складе и с каждой заявкой нужно это количество уменьшать
Форматы дат MON Yes Abbreviated name of month. MONTH Yes Name of month. • Множество форматов дат и PM P.M. Yes Meridian indicator with or without periods. времени Q Quarter of year (1, 2, 3, 4; January -March = 1). • Ошибки в обработке даты в RM Yes Roman numeral month (I-XII; January = I). RR Yes Lets you store 20th century dates in the 21st century разных системах using only two digits. SeeAlso:"The RR Datetime Format Element" RRRR Yes Round year. Accepts either 4-digit or 2-digit input. If 2digit, provides the same return as RR. If you do not want this functionality, then enter the 4-digit year. SS Yes Second (0-59). SSSSS Yes Seconds past midnight (0-86399). TS Yes Returns a value in the short time format. Makes the appearance of the time components (hour, minutes, and s
Достоинства и недостатки • Борьба с избыточностью и аномалиями • Высокоуровневый язык запросов • Необходимость операций соединения (JOIN), которые замедляют скорость • В реальности не нормализованные данные • Теорема CAP – согласованность, доступность, устойчивость к разделению
Интерфейс для администрирования БД • Adminer – web • Django Admin Panel – web • Data Grip десктоп
Миграции данных • Часто требуется создать БД, где часть таблиц уже заполнены данными – типы, виды и другие статичные данные. • Чтобы перенести данные из одной БД в другую можно использовать разные инструменты • Не путать с миграциями ORM – есть некоторые отличия • Например goose (не ORM) для Go • Или миграции Django ORM для Python
Трехзвенная архитектура • Традиционная SSR трехзвенная архитектура • Можно добавить модель и MVC
Курсоры • Использование обычных SQL запросов в коде бекенда • Django • Go
Когда выгодно использовать курсоры? • Если быстрее выполнить select сразу в БД:
Фреймворк Django. MVC
Традиционный серверный фреймворк • Статические файлы (статические HTML-документы, CSS, изображения, сценарии JavaScript и т.д.). • Контроллеры (обработчики событий пользовательских действий). • Модели (взаимодействие с БД). • Представления (view). Шаблоны, генерирующие HTML-страницы и другое динамическое содержимое. • Конфигурирование фреймворка: действия при запуске приложения, конфигурирование пользовательских сеансов (сессий), переписывание URL (привязка URL к контроллерам), безопасность (аутентификация и авторизация), кэширование, балансировка нагрузки, IOC / DI. • Утилиты командной строки для управления фреймворком. – Скаффолдинг (создание структуры проекта, генерация кода контроллеров и представлений на основе моделей, генерация кода приложения на основе специализированных описаний, генерация форм ввода и редактирования данных во время работы приложения). – Миграции (изменение структуры базы данных на основе моделей).
Мастер-класс Golang. Шаблонизация, ORM В ролике на VK/YouTube рассмотрены: • Примеры моделей и миграций • Пример структуры проекта с чистой архитектурой 1, 3 уровней • Реализация функций просмотра услуг и размера корзины • Обращение к БД через ORM / SQL
Чистая архитектура • Уровень Обработчиков: представления и контроллеры (обработчики) для нужного потребителя (HTML, JSON/API, куки) • Уровень Бизнес-логики, набор use-case’ов (сценариев): оплата, регистрация (+отправка e-mail), добавление в корзину, расчеты и тд • Пример use-case – при оплате заказа заставить гостя пройти регистрацию • Уровень Сущностей: взаимодействие с БД (обязательные поля при insert, логическое удаление) • Каждый уровень может меняться отдельно
ORM
Подключение к БД ORM • Для использования ORM, сначала укажем подключение к БД • Django • Go, gorm
Модель • Необходимо создать классы модели для наших таблиц • Django • gorm
Миграции ORM • Для создания таблиц в БД (DDL) на основе классов ORM нам требуется выполнить миграции ORM
Миграции Django Внесение изменений в модель: • Изменение модели (models.py). • Запуск команды python manage.py makemigrations для создания миграций этих изменений • Выполнение команды python manage.py migrate для применения этих изменений в базе данных. • $ python manage.py migrate • Opera(cid:129)ons to perform: • Apply all migra(cid:129)ons: admin, auth, conten(cid:130)ypes, polls, sessions • Running migra(cid:129)ons: • Rendering model states... DONE • Applying polls.0001_ini(cid:129)al... OK
QuerySet • Для добавления/редактирования/удаления или просто получения данных из БД (DМL) нам требуется QuerySet • Django >>> from blog.models import Blog, Entry >>> entry = Entry.objects.get(pk=1) • Go >>> cheese_blog = Blog.objects.get(name="Cheddar Talk") >>> entry.blog = cheese_blog >>> entry.save()
Рецепты Django ORM • https://django.fun/ru/docs/django-orm-cookbook/2.0/ • WHERE AND: Допустим, вы хотите найти пользователей, у которых firstname начинается с „R“ И last_name начинается с „D“. • UNION: Поскольку Hero и Villain оба имеют name и gender, можем использовать values_list для ограничения выбранных полей, и выполнить объединение.